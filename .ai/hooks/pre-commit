#!/bin/bash
# Pre-commit hook to enforce TDD practices
# This hook ensures tests pass and coverage is maintained before allowing commits

set -e

echo "ğŸ§ª Running pre-commit TDD checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Change to web-app directory where tests are located
cd web-app

# Check if there are any test files in the commit
TEST_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.test\.(ts|tsx|js|jsx)$' || true)
SOURCE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' | grep -v '\.test\.' | grep -v 'node_modules' || true)

# If source files are modified, ensure tests exist or are being added
if [ -n "$SOURCE_FILES" ] && [ -z "$TEST_FILES" ]; then
    echo -e "${YELLOW}âš ï¸  Warning: You are modifying source files without modifying tests.${NC}"
    echo "   Modified files:"
    echo "$SOURCE_FILES" | sed 's/^/     - /'
    echo ""
    echo "   TDD Reminder: Tests should be written BEFORE implementation."
    echo "   If this is a refactor and tests already exist, you can proceed."
    echo ""
    read -p "   Do you want to continue? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}âŒ Commit aborted. Write tests first!${NC}"
        exit 1
    fi
fi

# Run tests with coverage in a single pass
echo "ğŸƒ Running tests with coverage..."
if ! npm test -- --passWithNoTests --silent --coverage --coverageReporters=json-summary --coverageReporters=text-summary 2>&1 | tail -30; then
    echo -e "${RED}âŒ Tests failed! Fix failing tests before committing.${NC}"
    echo ""
    echo "TDD Workflow:"
    echo "  1. ğŸ”´ RED: Write failing test"
    echo "  2. ğŸŸ¢ GREEN: Make test pass"
    echo "  3. ğŸ”µ REFACTOR: Improve code"
    echo ""
    exit 1
fi

echo -e "${GREEN}âœ… All tests passed!${NC}"

# Check test coverage (only if there are test files)
if [ -n "$TEST_FILES" ] || [ -n "$SOURCE_FILES" ]; then
    echo "ğŸ“Š Checking test coverage..."

    if [ -f coverage/coverage-summary.json ]; then
        # Extract coverage percentages using node
        COVERAGE_CHECK=$(node -e "
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;
            const metrics = {
                statements: total.statements.pct,
                branches: total.branches.pct,
                functions: total.functions.pct,
                lines: total.lines.pct
            };

            const threshold = 80;
            let passed = true;
            let output = '';

            for (const [key, value] of Object.entries(metrics)) {
                const status = value >= threshold ? 'âœ…' : 'âŒ';
                output += \`\${status} \${key}: \${value.toFixed(2)}%\n\`;
                if (value < threshold) passed = false;
            }

            console.log(output);
            process.exit(passed ? 0 : 1);
        ")

        COVERAGE_EXIT_CODE=$?
        echo "$COVERAGE_CHECK"

        if [ $COVERAGE_EXIT_CODE -ne 0 ]; then
            echo -e "${RED}âŒ Coverage below 80% threshold!${NC}"
            echo ""
            echo "Add more tests to improve coverage:"
            echo "  - Test edge cases"
            echo "  - Test error handling"
            echo "  - Test all conditional branches"
            echo ""
            echo "To see detailed coverage report:"
            echo "  npm test -- --coverage"
            echo "  open coverage/lcov-report/index.html"
            echo ""
            read -p "Do you want to commit anyway? (y/N): " -n 1 -r
            echo ""
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 1
            fi
        else
            echo -e "${GREEN}âœ… Coverage meets threshold!${NC}"
        fi
    else
        echo -e "${YELLOW}âš ï¸  Could not generate coverage report${NC}"
    fi
fi

# Check commit message format
COMMIT_MSG_FILE=$1
if [ -n "$COMMIT_MSG_FILE" ] && [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

    # Check if commit message follows conventional commits format
    if ! echo "$COMMIT_MSG" | grep -qE '^(test|feat|fix|refactor|docs|chore|style|perf)(\(.+\))?: .+'; then
        echo -e "${YELLOW}âš ï¸  Commit message doesn't follow conventional commits format${NC}"
        echo ""
        echo "Expected format:"
        echo "  <type>(<scope>): <subject>"
        echo ""
        echo "Types:"
        echo "  test:     Adding or modifying tests (RED phase)"
        echo "  feat:     New feature (GREEN phase)"
        echo "  refactor: Code improvements (REFACTOR phase)"
        echo "  fix:      Bug fixes"
        echo "  docs:     Documentation"
        echo "  chore:    Build, configs, dependencies"
        echo ""
        echo "Example:"
        echo "  test(employee): add failing test for skill validation"
        echo "  feat(employee): implement skill validation"
        echo "  refactor(employee): extract validation to utility"
        echo ""
    fi
fi

echo -e "${GREEN}âœ… Pre-commit checks passed!${NC}"
echo ""

# Check for documentation requirements
cd ..
TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
AGENT_ID=${AGENT_ID:-"human-developer"}

echo "ğŸ“ Checking documentation requirements..."

# Check if feature docs needed
FEATURE_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E 'app/lib/[^/]+\.ts$' | grep -v test | grep -v types || true)
if [ -n "$FEATURE_FILES" ]; then
    echo -e "${YELLOW}ğŸ“š Reminder: New features require documentation${NC}"
    echo "   Files: $FEATURE_FILES"
    echo "   - Create feature doc: .ai/templates/feature-doc.md"
    echo "   - Update CHANGELOG.md with entry"
    echo ""
fi

# Check if API docs needed
API_FILES=$(git diff --cached --name-only --diff-filter=AM | grep 'app/api/.*/route\.ts$' || true)
if [ -n "$API_FILES" ]; then
    echo -e "${YELLOW}ğŸŒ Reminder: API changes require documentation${NC}"
    echo "   Files: $API_FILES"
    echo "   - Create API doc: .ai/templates/api-endpoint-doc.md"
    echo "   - Update CHANGELOG.md with entry"
    echo ""
fi

# Check if CHANGELOG updated
CHANGELOG_UPDATED=$(git diff --cached --name-only | grep "CHANGELOG.md" || true)
if [ -z "$CHANGELOG_UPDATED" ] && ([ -n "$FEATURE_FILES" ] || [ -n "$API_FILES" ] || [ -n "$SOURCE_FILES" ]); then
    echo -e "${YELLOW}ğŸ“„ Consider updating CHANGELOG.md${NC}"
    echo "   Add entry under [Unreleased] section"
    echo ""
fi

# Update development log
if [ -n "$TEST_FILES" ]; then
    echo "{\"timestamp\":\"$TIMESTAMP\",\"agent\":\"$AGENT_ID\",\"action\":\"tests_modified\",\"details\":\"Modified test files in commit\",\"files\":[\"$(echo $TEST_FILES | sed 's/ /","/g')\"]}" >> .ai/artifacts/logs/development.jsonl
fi

echo "âœ… Documentation checks complete"
echo ""

exit 0
