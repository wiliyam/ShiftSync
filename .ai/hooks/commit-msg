#!/bin/bash
# Commit message hook to enforce conventional commits format

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Conventional commits pattern
PATTERN='^(test|feat|fix|refactor|docs|chore|style|perf|ci|build|revert)(\(.+\))?: .{1,100}'

if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
    echo -e "${RED}‚ùå Invalid commit message format!${NC}"
    echo ""
    echo "Commit message must follow conventional commits format:"
    echo -e "${GREEN}<type>(<scope>): <subject>${NC}"
    echo ""
    echo "Types (TDD workflow):"
    echo "  ${YELLOW}test${NC}:     üî¥ RED - Adding or modifying tests (write failing test first)"
    echo "  ${GREEN}feat${NC}:     üü¢ GREEN - New feature implementation (make test pass)"
    echo "  ${YELLOW}refactor${NC}: üîµ REFACTOR - Code improvements (clean up while tests still pass)"
    echo ""
    echo "Other types:"
    echo "  fix:      Bug fixes"
    echo "  docs:     Documentation only"
    echo "  chore:    Build, configs, dependencies"
    echo "  style:    Code style changes (formatting, etc.)"
    echo "  perf:     Performance improvements"
    echo "  ci:       CI/CD changes"
    echo "  build:    Build system changes"
    echo "  revert:   Revert previous commit"
    echo ""
    echo "Examples:"
    echo "  ${GREEN}test(employee): add failing test for duplicate skill detection${NC}"
    echo "  ${GREEN}feat(employee): implement skill validation logic${NC}"
    echo "  ${GREEN}refactor(employee): extract validation to utility module${NC}"
    echo "  ${GREEN}fix(shift): correct overlap detection in time ranges${NC}"
    echo ""
    echo "Your commit message:"
    echo "  $COMMIT_MSG"
    echo ""
    exit 1
fi

# Extract type from commit message
TYPE=$(echo "$COMMIT_MSG" | sed -E 's/^([a-z]+)(\(.+\))?: .*/\1/')

# Provide helpful reminders based on commit type
case "$TYPE" in
    test)
        echo -e "${YELLOW}üî¥ RED Phase${NC} - Creating failing test"
        echo "Remember: Test should fail for the right reason!"
        ;;
    feat)
        echo -e "${GREEN}üü¢ GREEN Phase${NC} - Implementing feature"
        echo "Remember: Write minimum code to pass the test!"
        ;;
    refactor)
        echo -e "üîµ ${YELLOW}REFACTOR Phase${NC} - Improving code"
        echo "Remember: All tests should still pass!"
        ;;
    fix)
        echo -e "${RED}üêõ BUG FIX${NC}"
        echo "Reminder: Did you write a test that reproduces the bug first?"
        ;;
esac

exit 0
